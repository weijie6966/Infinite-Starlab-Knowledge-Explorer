<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Infinite Starlab Knowledge Explorer — Space Biology Learning</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            spaceBlue: '#0b1d3a',
            spacePurple: '#5b3c99',
          }
        }
      }
    }
  </script>
  <style>
    /* Starry background */
    .starry-bg { background: radial-gradient(ellipse at bottom, #0b1d3a 0%, #000 70%); }
    .twinkle { position: absolute; left:0; top:0; right:0; bottom:0; pointer-events:none; }
    .twinkle::before, .twinkle::after { content:''; position:absolute; left:0; top:0; right:0; bottom:0; background:
      radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,0.9) 0, rgba(255,255,255,0) 60%),
      radial-gradient(1.5px 1.5px at 80% 20%, rgba(255,255,255,0.7) 0, rgba(255,255,255,0) 60%),
      radial-gradient(1.8px 1.8px at 50% 70%, rgba(255,255,255,0.8) 0, rgba(255,255,255,0) 60%),
      radial-gradient(1px 1px at 30% 60%, rgba(255,255,255,0.6) 0, rgba(255,255,255,0) 60%),
      radial-gradient(1px 1px at 60% 40%, rgba(255,255,255,0.6) 0, rgba(255,255,255,0) 60%);
      animation: twinkle 6s linear infinite;
    }
    .twinkle::after { filter: blur(1px); opacity: 0.6; animation-duration: 9s; }
    @keyframes twinkle { 0%{opacity:.6} 50%{opacity:1} 100%{opacity:.6} }
    
    /* Constellation lines */
    .constellation { position: absolute; left:0; top:0; right:0; bottom:0; pointer-events:none; opacity: 0.3; }
    .constellation svg { width: 100%; height: 100%; }
    .constellation-line { stroke: rgba(255,255,255,0.2); stroke-width: 1; fill: none; 
      stroke-dasharray: 2,4; animation: constellation-glow 8s ease-in-out infinite; }
    @keyframes constellation-glow { 0%,100%{opacity:0.2} 50%{opacity:0.4} }
    
    /* Meteor shower */
    .meteor-container { position: absolute; left:0; top:0; right:0; bottom:0; pointer-events:none; overflow: hidden; }
    .meteor { position: absolute; width: 3px; height: 3px; background: radial-gradient(circle, rgba(255,255,255,0.9), transparent);
      border-radius: 50%; animation: meteor-fall linear infinite; transform-origin: center; }
    .meteor::before { content: ''; position: absolute; top: 50%; left: 50%; width: 80px; height: 1px;
      background: linear-gradient(150deg, rgba(255,255,255,0.8), transparent); 
      transform: translate(-50%, -50%) rotate(150deg); transform-origin: left center; }
    .meteor:nth-child(1) { right: 10%; top: -50px; animation-duration: 3s; animation-delay: 0s; }
    .meteor:nth-child(2) { right: 30%; top: -80px; animation-duration: 4s; animation-delay: 2s; }
    .meteor:nth-child(3) { right: 60%; top: -120px; animation-duration: 3.5s; animation-delay: 5s; }
    .meteor:nth-child(4) { right: 80%; top: -90px; animation-duration: 4.5s; animation-delay: 8s; }
    .meteor:nth-child(5) { right: 45%; top: -60px; animation-duration: 3.2s; animation-delay: 12s; }
    @keyframes meteor-fall { 
      0% { transform: translate(0, 0) rotate(150deg); opacity: 0; }
      10% { opacity: 1; } 
      90% { opacity: 1; } 
      100% { transform: translate(-150vw, 150vh) rotate(150deg); opacity: 0; } 
    }
    
    .glass-card { background: rgba(255,255,255,0.06); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.15); }
    .glow { text-shadow: 0 0 8px rgba(255,255,255,0.6); }
    .btn-glow { box-shadow: 0 0 12px rgba(123, 97, 255, 0.6); }
    .disabled { opacity: .5; cursor: not-allowed; }
    /* Hide Key Finding and Quiz buttons */
    #startLearningBtn, #quizBtn, #quizLockMsg { display: none !important; }
  </style>
</head>
<body class="min-h-screen text-white starry-bg relative">
  <div class="twinkle"></div>
  
  <!-- Constellation lines -->
  <div class="constellation">
    <svg>
      <line class="constellation-line" x1="10%" y1="20%" x2="25%" y2="15%"></line>
      <line class="constellation-line" x1="25%" y1="15%" x2="35%" y2="25%"></line>
      <line class="constellation-line" x1="35%" y1="25%" x2="45%" y2="18%"></line>
      <line class="constellation-line" x1="60%" y1="30%" x2="75%" y2="25%"></line>
      <line class="constellation-line" x1="75%" y1="25%" x2="85%" y2="35%"></line>
      <line class="constellation-line" x1="85%" y1="35%" x2="90%" y2="20%"></line>
      <line class="constellation-line" x1="15%" y1="60%" x2="30%" y2="55%"></line>
      <line class="constellation-line" x1="30%" y1="55%" x2="40%" y2="65%"></line>
      <line class="constellation-line" x1="55%" y1="70%" x2="70%" y2="65%"></line>
      <line class="constellation-line" x1="70%" y1="65%" x2="80%" y2="75%"></line>
    </svg>
  </div>
  
  <!-- Meteor shower -->
  <div class="meteor-container">
    <div class="meteor"></div>
    <div class="meteor"></div>
    <div class="meteor"></div>
    <div class="meteor"></div>
    <div class="meteor"></div>
  </div>
  <!-- Navbar -->
  <nav class="w-full glass-card">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl font-bold glow">∞</span>
        <span class="text-xl font-semibold glow">Infinite Starlab Knowledge Explorer</span>
      </div>
      <div class="flex items-center gap-6">
        <a href="index.html" class="hover:text-blue-300">Home</a>
        <a href="graph.html" class="hover:text-blue-300">Knowledge Graph</a>
        <a href="dashboard.html" class="hover:text-blue-300 hidden">My Learning</a>
        <a href="about.html" class="hover:text-blue-300">About</a>
      </div>
    </div>
  </nav>

  <!-- Main Sections -->
  <main class="max-w-4xl mx-auto px-4 py-4">
    <!-- Home -->
    <section id="home" class="min-h-[70vh] flex flex-col justify-center items-center space-y-6">
      <div class="text-center">
        <h1 class="text-4xl md:text-5xl font-bold glow mb-4">Explore Space Biology</h1>
        <p class="text-lg text-white/80 max-w-2xl mx-auto">Making astrobiology research accessible and connected to usher in a new era of exploration</p>
      </div>
      <div class="flex items-center justify-center gap-4 mt-8">
        <button id="enterGraphBtn" class="px-8 py-4 text-lg rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 btn-glow transform hover:scale-105 transition-all duration-300">Explore Knowledge Graph</button>
      </div>
    </section>

    <!-- Knowledge Graph moved to graph.html -->

    <!-- Module Intro -->
    <section id="moduleIntro" class="hidden mt-6">
      <div class="glass-card p-6 rounded-lg">
        <h2 id="moduleTitle" class="text-2xl font-bold glow"></h2>
        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <div>
            <h3 class="font-semibold">Background</h3>
            <p id="sumBackground" class="text-white/80"></p>
            <h3 class="mt-3 font-semibold">Objective</h3>
            <p id="sumObjective" class="text-white/80"></p>
            <h3 class="mt-3 font-semibold">Methods</h3>
            <p id="sumMethods" class="text-white/80"></p>
          </div>
          <div>
            <h3 class="font-semibold">Results</h3>
            <p id="sumResults" class="text-white/80"></p>
            <h3 class="mt-3 font-semibold">Conclusion</h3>
            <p id="sumConclusion" class="text-white/80"></p>
          </div>
        </div>
        <div class="mt-6">
          <h3 class="font-semibold">Extracted Entities</h3>
          <div id="extractedEntitiesBox" class="text-white/80 text-sm space-y-2"></div>
        </div>
        <div class="mt-6">
          <h3 class="font-semibold">Relationship Matrix</h3>
          <div id="connectionsMatrixBox" class="text-white/80 text-sm mt-2"></div>
        </div>
        <div class="mt-5 flex gap-3">
          <button id="startLearningBtn" class="px-5 py-3 rounded bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 btn-glow">Key Finding</button>
          <button id="quizBtn" class="px-5 py-3 rounded bg-gradient-to-r from-indigo-600 to-pink-600 btn-glow">Quiz</button>
          <span id="quizLockMsg" class="self-center text-white/70"></span>
          <button id="backToGraphBtn" class="ml-auto px-5 py-3 rounded bg-white/10 hover:bg-white/20 btn-glow">Back to Knowledge Graph</button>
        </div>
      </div>
    </section>

    <!-- Outline -->
    <section id="outline" class="hidden mt-6">
      <div class="grid md:grid-cols-3 gap-4">
        <aside class="md:col-span-1 glass-card rounded-lg p-5">
          <h3 class="font-semibold mb-3">Learning Notes</h3>
          <div id="notesList" class="space-y-2"></div>
        </aside>
        <article class="md:col-span-2 glass-card rounded-lg p-5">
          <div class="flex items-center gap-2 mb-2"><span>⭐</span><h3 id="noteTitle" class="font-semibold">Select a note</h3></div>
          <p id="noteContent" class="text-white/80"></p>
          <div class="mt-4">
            <div class="flex gap-3">
              <button id="backNoteBtn" class="px-5 py-3 rounded bg-gradient-to-r from-indigo-600 to-blue-600 btn-glow">Back</button>
              <button id="nextNoteBtn" class="px-5 py-3 rounded bg-indigo-600 btn-glow">Next</button>
              <button id="finishOutlineBtn" class="px-5 py-3 rounded bg-gradient-to-r from-blue-600 to-purple-600 btn-glow hidden">Finish Outline</button>
            </div>
          </div>
        </article>
      </div>
    </section>

    <!-- Quiz -->
    <section id="quiz" class="hidden mt-6">
      <div class="glass-card p-6 rounded-lg">
        <h3 class="font-semibold glow">Quiz</h3>
        <div id="quizContainer" class="mt-3 space-y-4"></div>
        <div class="mt-4 flex items-center gap-3">
          <button id="submitQuizBtn" class="px-5 py-3 rounded bg-indigo-600 btn-glow disabled">Submit</button>
          <button id="completeQuizBtn" class="px-5 py-3 rounded bg-gradient-to-r from-indigo-600 to-pink-600 btn-glow disabled">Complete</button>
          <span id="quizStatus" class="text-white/70"></span>
        </div>
      </div>
    </section>

    <!-- Dashboard moved to dashboard.html -->

    <!-- About moved to about.html -->
  </main>

  <!-- Achievement Popup -->
  <div id="achievementPopup" class="fixed inset-0 hidden items-center justify-center bg-black/60">
    <div class="glass-card p-6 rounded-lg text-center">
      <div class="text-4xl mb-2">🎉</div>
      <h3 class="text-2xl font-bold glow">You unlocked a new star!</h3>
      <p class="text-white/80 mt-1">Great job completing the quiz.</p>
      <button id="closePopup" class="mt-4 px-5 py-2 rounded bg-gradient-to-r from-blue-600 to-purple-600 btn-glow">Close</button>
    </div>
  </div>
  
  <!-- Quiz Fail Popup (时间到) -->
  <div id="quizFailPopup" class="fixed inset-0 hidden items-center justify-center bg-black/60">
    <div class="glass-card p-6 rounded-lg text-center">
      <h3 class="text-2xl font-bold glow">Time's up！</h3>
      <p class="text-white/80 mt-1">This quiz session has ended.</p>
      <div class="mt-4 flex gap-3 justify-center">
        <button id="failRestartBtn" class="px-5 py-2 rounded bg-gradient-to-r from-indigo-600 to-blue-600 text-white btn-glow">Restart Quiz</button>
        <button id="failBackBtn" class="px-5 py-2 rounded bg-gradient-to-r from-blue-600 to-purple-600 text-white btn-glow">Back to Learning</button>
      </div>
    </div>
  </div>
  
  <!-- Quiz Result Popup (提交非全对) -->
  <div id="quizResultPopup" class="fixed inset-0 hidden items-center justify-center bg-black/60">
    <div class="glass-card p-6 rounded-lg text-center">
      <h3 class="text-2xl font-bold glow">Quiz Results</h3>
      <p id="quizResultText" class="text-white/80 mt-1"></p>
      <div class="mt-4 flex gap-3 justify-center">
        <button id="resultRestartBtn" class="px-5 py-2 rounded bg-gradient-to-r from-indigo-600 to-blue-600 text-white btn-glow">Restart Quiz</button>
        <button id="resultBackBtn" class="px-5 py-2 rounded bg-gradient-to-r from-blue-600 to-purple-600 text-white btn-glow">Back to Learning</button>
      </div>
    </div>
  </div>

  <script>
    // ---- Simple Router ----
    const sections = ['home','moduleIntro','outline','quiz'];
    function show(sectionId){ sections.forEach(id=>{ const el=document.getElementById(id); if(el) el.classList.toggle('hidden', id!==sectionId); }); }
    document.querySelectorAll('nav [data-route]').forEach(btn=>btn.addEventListener('click',()=>{
      const route = btn.getAttribute('data-route');
      if(route==='home') show('home');
      // Graph, Dashboard, About moved to standalone pages
    }));
    document.getElementById('enterGraphBtn').onclick = ()=>{ window.location.href = 'graph.html'; };

    // ---- Data Loading ----
    let modules = [];
    let currentModule = null;
    let categoryColorMap = {};
    async function loadCategoryColors(){
      try {
        const res = await fetch('categories/categories_color.json');
        const data = await res.json();
        categoryColorMap = {};
        if (data && Array.isArray(data.categories)) {
          data.categories.forEach(it => {
            if (it && it.name != null && it.color != null) {
              categoryColorMap[String(it.name)] = String(it.color);
            }
          });
        }
      } catch(e){ /* ignore */ }
    }
    loadCategoryColors();
    const statusEl = document.getElementById('dataStatus');
    function normalizeCoursesData(data, srcName){
      const arr = Array.isArray(data) ? data : [data];
      const base = (srcName||'').split('/').pop().replace(/\.json$/i,'');
      return arr.map((m, idx)=>{
        let id = m && m.id != null ? String(m.id).trim() : '';
        if(!id && m && m.paper_id != null) id = String(m.paper_id).trim();
        if(!id && m && m.title != null) id = String(m.title).trim();
        if(!id){
          if(m && m.module && m.module.id != null) id = String(m.module.id).trim();
          else if(m && m.course && m.course.id != null) id = String(m.course.id).trim();
          else id = base ? `${base}-${idx+1}` : `module-${idx+1}`;
        }
        return Object.assign({}, m, { id });
      });
    }
    async function loadAllModulesFromDataDir(){
      let files = [];
      try {
        const res = await fetch('data/');
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const anchors = Array.from(doc.querySelectorAll('a'));
        files = anchors
          .map(a => a.getAttribute('href') || '')
          .filter(href => href.toLowerCase().endsWith('.json'));
      } catch(e){
        files = ['example.json', 'data/example.json'];
      }
      modules = [];
      for(const href of files){
        const url = (href.startsWith('data/') || href.startsWith('/')) ? href : ('data/' + href);
        try {
          const r = await fetch(url);
          const d = await r.json();
          const srcName = href.split('/').pop();
          modules.push(...normalizeCoursesData(d, srcName));
        } catch(err) {
          // skip invalid json
        }
      }
      modules = modules.filter(m=>m && m.id != null).map(m=> Object.assign({}, m, { id: String(m.id).trim() }));
      if(statusEl) statusEl.textContent = 'Auto-loaded ' + files.length + ' file(s), ' + modules.length + ' module(s)';
      // Open module intro or notes if moduleId is provided in URL
      const params = new URLSearchParams(location.search);
      const mid = params.get('moduleId');
      const start = params.get('start');
      if(mid){
        let found = modules.find(m=>m.id===mid) || modules.find(m=>String(m.paper_id||'')===mid) || modules.find(m=>String(m.title||'')===mid);
        if(found){
          currentModule = found;
          if(start === 'notes'){ openOutline(found); show('outline'); }
          else if(start === 'quiz'){ renderQuiz(found); show('quiz'); }
          else { openModuleIntro(found); show('moduleIntro'); }
        }
      }
    }
    loadAllModulesFromDataDir();
    const fileInput = document.getElementById('courseFile');
    const loadBtnEl = document.getElementById('loadJsonBtn');
    if(loadBtnEl && fileInput){ loadBtnEl.onclick = ()=> fileInput.click(); }
    if(fileInput){
      fileInput.onchange = async () => {
        const file = fileInput.files[0]; if(!file) return;
        const text = await file.text();
        modules = normalizeCoursesData(JSON.parse(text), file.name);
        if(statusEl) statusEl.textContent = 'Loaded: '+file.name;
        const params = new URLSearchParams(location.search);
        const mid = params.get('moduleId');
        const start = params.get('start');
        if(mid){
          let found = modules.find(m=>m.id===mid) || modules.find(m=>String(m.paper_id||'')===mid) || modules.find(m=>String(m.title||'')===mid);
          if(found){
            currentModule = found;
            if(start === 'notes'){ openOutline(found); show('outline'); return; }
            if(start === 'quiz'){ renderQuiz(found); show('quiz'); return; }
            openModuleIntro(found); show('moduleIntro'); return;
          }
        }
      };
    }

    // ---- Progress Storage ----
    const PROG_KEY = 'learningProgress';
    function getProgress(){ return JSON.parse(localStorage.getItem(PROG_KEY)||'{}'); }
    function setProgress(p){ localStorage.setItem(PROG_KEY, JSON.stringify(p)); }
    function updateModuleProgress(id, upd){ const p=getProgress(); p[id]=Object.assign({completed:false, unlocked:false}, p[id]||{}, upd); setProgress(p); refreshContinueBtn(); }
    function getModuleProgress(id){ const p=getProgress(); return p[id]||{completed:false, unlocked:false}; }
    function refreshContinueBtn(){ 
      // Continue button has been removed, no action needed
    }

    // ---- Knowledge Graph Render ----
    // Graph functionality moved to graph.html
    // ---- Module Intro ----
    function openModuleIntro(m){ currentModule = m; show('moduleIntro');
      document.getElementById('moduleTitle').textContent = m.title || m.id;
      const s = m.summary || {};
      const bg = (s.background || m.background || m.description || '');
      const obj = (s.objective || m.objective || (Array.isArray(m.objectives)? m.objectives.join('; '):''));
      const methods = (s.methods || m.methods || m.method || m.methodology || '');
      const results = (s.results || m.results || m.findings || m.outcomes || '');
      const conclusion = (s.conclusion || s.conclusions || m.conclusion || m.conclusions || '');
      document.getElementById('sumBackground').textContent = bg;
      document.getElementById('sumObjective').textContent = obj;
      document.getElementById('sumMethods').textContent = methods;
      document.getElementById('sumResults').textContent = results;
      document.getElementById('sumConclusion').textContent = conclusion;
      const eeBox = document.getElementById('extractedEntitiesBox');
      if(eeBox){ const ee = m.extracted_entities || (s.extracted_entities || null); eeBox.innerHTML = renderExtractedEntitiesHTML(ee); initExtractedEntitiesTabs(eeBox); }
      const prog = getModuleProgress(m.id);
      // Quiz button lock
      const quizBtn=document.getElementById('quizBtn'); const msg=document.getElementById('quizLockMsg');
      quizBtn.classList.toggle('disabled', !prog.completed);
      msg.textContent = prog.completed ? '' : 'Quiz is locked until learning is completed';
      // Render connections matrix in summary page
      renderConnectionsMatrixIntro(m);
    }
    document.getElementById('startLearningBtn').onclick = ()=>{ openModuleIntro(currentModule); show('moduleIntro'); };
    document.getElementById('quizBtn').onclick = ()=>{ const p=getModuleProgress(currentModule.id); if(!p.completed) return; renderQuiz(currentModule); show('quiz'); };
    document.getElementById('backToGraphBtn').onclick = ()=>{ window.location.href = 'graph.html'; };

    // ---- Outline ----
    const notesListEl = document.getElementById('notesList');
    let currentNoteIdx = 0;
     function openOutline(m){ currentModule = m; show('outline'); notesListEl.innerHTML='';
       const notes = m.learning_notes || [];
       const prog = getModuleProgress(m.id);
       if(!Array.isArray(prog.notesCompleted)) prog.notesCompleted = [];
       // 左侧仅显示编号，已完成为绿色
       notes.forEach((n, idx)=>{
         const completed = prog.notesCompleted.includes(idx);
         const item = document.createElement('button');
         item.className = 'w-full text-left px-3 py-2 rounded border border-white/10 ' + (completed ? 'bg-green-600 hover:bg-green-600' : 'bg-white/5 hover:bg-white/10');
         item.textContent = String(idx+1);
         item.dataset.idx = idx;
         item.onclick = ()=>{ currentNoteIdx = idx; renderCurrentNote(); };
         notesListEl.appendChild(item);
       });
       if(currentNoteIdx>=notes.length) currentNoteIdx = 0;
       renderCurrentNote();
       // 按钮逻辑
       const nextBtn = document.getElementById('nextNoteBtn');
       const backBtn = document.getElementById('backNoteBtn');
       const finishBtn = document.getElementById('finishOutlineBtn');

       // NEXT：标记当前为完成并进入下一条
       nextBtn.onclick = ()=>{
         const p2 = getModuleProgress(m.id);
         const completedArr = Array.isArray(p2.notesCompleted) ? p2.notesCompleted.slice() : [];
         if(!completedArr.includes(currentNoteIdx)) completedArr.push(currentNoteIdx);
         updateModuleProgress(m.id, {notesCompleted: completedArr});
         const leftItem = notesListEl.children[currentNoteIdx];
         if(leftItem) leftItem.className = leftItem.className.replace('bg-white/5 hover:bg-white/10','bg-green-600 hover:bg-green-600');
         if(currentNoteIdx < notes.length-1){ currentNoteIdx++; renderCurrentNote(); }
       };

       // BACK：1 返回 dashboard；其余返回上一条
       backBtn.onclick = ()=>{
         if(currentNoteIdx === 0){
           window.location.href = 'graph.html';
         } else {
           currentNoteIdx = Math.max(0, currentNoteIdx-1);
           renderCurrentNote();
         }
       };

       // Finish：在最后一条时可见，点击时确保计入最后一条并完成大纲（若全部完成）
       finishBtn.onclick = ()=>{
         if(!currentModule) return;
         const p2 = getModuleProgress(currentModule.id);
         const completedArr = Array.isArray(p2.notesCompleted) ? p2.notesCompleted.slice() : [];
         if(!completedArr.includes(currentNoteIdx)) completedArr.push(currentNoteIdx);
         updateModuleProgress(currentModule.id, {notesCompleted: completedArr});
         const totalNotes = (currentModule.learning_notes || []).length;
         const doneCount = getModuleProgress(currentModule.id).notesCompleted.length;
         if(doneCount >= totalNotes && totalNotes>0){
           updateModuleProgress(currentModule.id, {completed:true, unlocked:false});
           openModuleIntro(currentModule);
           show('moduleIntro');
         }
       };

       function renderCurrentNote(){
         document.getElementById('noteTitle').textContent = 'Note ' + (currentNoteIdx+1);
         document.getElementById('noteContent').textContent = notes[currentNoteIdx]?.note || '';
         const nextBtn = document.getElementById('nextNoteBtn');
         const finishBtn = document.getElementById('finishOutlineBtn');
         // 显示规则：
         // 1：Next & Back
         // 2-6：Next & Back
         // 7（最后一条）：Back & Finish
         nextBtn.classList.toggle('hidden', currentNoteIdx === notes.length-1);
         finishBtn.classList.toggle('hidden', currentNoteIdx !== notes.length-1);
         Array.from(notesListEl.children).forEach((btn,i)=>{
           btn.classList.remove('ring-2','ring-indigo-400');
           if(i===currentNoteIdx) btn.classList.add('ring-2','ring-indigo-400');
         });
       }
     }
     document.getElementById('finishOutlineBtn').onclick = ()=>{
       if(!currentModule) return;
       const p2 = getModuleProgress(currentModule.id);
       const completedArr = Array.isArray(p2.notesCompleted) ? p2.notesCompleted.slice() : [];
       if(!completedArr.includes(currentNoteIdx)) completedArr.push(currentNoteIdx);
       updateModuleProgress(currentModule.id, {notesCompleted: completedArr});
       const totalNotes = (currentModule.learning_notes || []).length;
       const doneCount = getModuleProgress(currentModule.id).notesCompleted.length;
       if(doneCount >= totalNotes && totalNotes>0){
         updateModuleProgress(currentModule.id, {completed:true, unlocked:false});
         openModuleIntro(currentModule);
         show('moduleIntro');
       }
     };

    // ---- Quiz ----
    function renderQuiz(m){
      const cont = document.getElementById('quizContainer');
      cont.innerHTML = '';
      // 清理旧的重启按钮与计时器
      const existingRestart = document.getElementById('restartQuizBtn'); if(existingRestart) existingRestart.remove();
      if(window.quizTimerId){ clearInterval(window.quizTimerId); window.quizTimerId = null; }
      // 停止可能遗留的测验背景音乐
      if(window.stopQuizMusic){ window.stopQuizMusic(); }
      // 定义测验背景音乐的全局启动/停止方法（供提交与完成时调用）
      window.startQuizMusic = function(){
        try{
          if(window.quizBgmAudio){ try{ window.quizBgmAudio.pause(); }catch(_){} }
          const a = new Audio('sound/countdown_sound.mp3');
          a.loop = true; // 保证在30秒内一直播放
          window.quizBgmAudio = a;
          a.play().catch(err=>console.warn('Quiz BGM play failed:', err));
        }catch(e){ console.warn('Quiz BGM error:', e); }
      };
      window.stopQuizMusic = function(){
        const a = window.quizBgmAudio;
        if(a){ try{ a.pause(); a.currentTime = 0; }catch(_){} }
        window.quizBgmAudio = null;
      };
      const completeBtn = document.getElementById('completeQuizBtn');
      completeBtn.classList.add('disabled');
      const submitBtn = document.getElementById('submitQuizBtn');
      submitBtn.classList.add('disabled');
      let quizFailed = false; let quizSubmitted = false;
      // 计时器 UI
      const total = 30; let remain = 30;
      const timerBox = document.createElement('div'); timerBox.className = 'mb-3';
      const timerLabel = document.createElement('div'); timerLabel.id = 'timerText'; timerLabel.className = 'text-white/80 mb-2'; timerLabel.textContent = 'Time left: '+remain+'s';
      const barOuter = document.createElement('div'); barOuter.className = 'w-full h-2 bg-white/10 rounded overflow-hidden';
      const barInner = document.createElement('div'); barInner.id = 'timeBar'; barInner.className = 'h-2 bg-green-500'; barInner.style.width = '100%';
      barOuter.appendChild(barInner); timerBox.appendChild(timerLabel); timerBox.appendChild(barOuter); cont.appendChild(timerBox);

      const questions = m.quiz || [];
      const selectedBtn = new Array(questions.length).fill(null);
      const selected = new Array(questions.length).fill(null);

      questions.forEach((q, qi)=>{
        const card = document.createElement('div'); card.className='p-3 rounded bg-white/5 border border-white/10';
        const title = document.createElement('div'); title.className='font-semibold mb-2'; title.textContent=(qi+1)+'. '+q.question; card.appendChild(title);
        const opts = document.createElement('div'); opts.className='grid md:grid-cols-2 gap-2';
        q.options.forEach(opt=>{
          const btn=document.createElement('button'); btn.className='px-3 py-2 rounded bg-white/10 hover:bg-white/20'; btn.textContent=opt;
          btn.onclick=()=>{
            if(quizFailed || quizSubmitted) return;
            // 记录选择
            selected[qi] = opt;
            selectedBtn[qi] = btn;
            // 更新该题所有按钮外观：已选择为“非红非绿”的突出颜色
            Array.from(opts.querySelectorAll('button')).forEach(b=>{
              if(b === btn){ b.className = 'px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-600'; }
              else { b.className = 'px-3 py-2 rounded bg-white/10 hover:bg-white/20'; }
            });
            updateQuizStatus();
          };
          opts.appendChild(btn);
        });
        card.appendChild(opts); cont.appendChild(card);
      });

      function updateQuizStatus(){
        const statusEl = document.getElementById('quizStatus');
        const allSelected = selected.every(v=> v!==null);
        if(quizFailed){
          statusEl.textContent = 'Time is up! Failed. Please restart.';
          submitBtn.classList.add('disabled');
          completeBtn.classList.add('disabled');
        } else if(!quizSubmitted){
          statusEl.textContent = allSelected ? 'All selected. Click Submit to check answers.' : 'Select answers and click Submit.';
          submitBtn.classList.toggle('disabled', !allSelected);
          completeBtn.classList.add('disabled');
        } else {
          // 提交之后的状态在提交逻辑里更新
        }
      }
      updateQuizStatus();

      // 倒计时逻辑
      const updateTimerUI = ()=>{
        timerLabel.textContent = 'Time left: '+remain+'s';
        const pct = Math.max(0, Math.min(100, Math.floor(remain*100/total)));
        barInner.style.width = pct + '%';
        barInner.className = 'h-2 ' + (pct<=30 ? 'bg-red-500' : (pct<=60 ? 'bg-yellow-500' : 'bg-green-500'));
      };
      updateTimerUI();
      // 启动测验背景音乐
      if(window.startQuizMusic){ window.startQuizMusic(); }
      window.quizTimerId = setInterval(()=>{
        remain--;
        // 先更新到当前秒数，保证能显示到0s
        updateTimerUI();
        if(remain <= 0){
          clearInterval(window.quizTimerId); window.quizTimerId = null; quizFailed = true;
          // 倒计时结束时停止音乐
          if(window.stopQuizMusic){ window.stopQuizMusic(); }
          // 禁用所有选项按钮
          cont.querySelectorAll('.p-3 button, .grid button').forEach(b=> b.disabled = true);
          // 弹出“时间到”窗口
          const failPop = document.getElementById('quizFailPopup');
          failPop.classList.remove('hidden'); failPop.classList.add('flex');
          const restartBtn = document.getElementById('failRestartBtn');
          const backBtn = document.getElementById('failBackBtn');
          restartBtn.onclick = ()=>{ failPop.classList.add('hidden'); failPop.classList.remove('flex'); renderQuiz(m); show('quiz'); };
          backBtn.onclick = ()=>{
            failPop.classList.add('hidden'); failPop.classList.remove('flex');
            openOutline(currentModule); show('outline');
          };
        }
      }, 1000);

      // 提交答案按钮
      submitBtn.onclick = ()=>{
        // 点击提交时立即停止音乐
        if(window.stopQuizMusic){ window.stopQuizMusic(); }
        if(submitBtn.classList.contains('disabled') || quizFailed || quizSubmitted) return;
        quizSubmitted = true;
        // 提交后停止计时，避免提交后继续计时导致失败
        if(window.quizTimerId){ clearInterval(window.quizTimerId); window.quizTimerId = null; }
        // 统一判定并着色
        let allCorrect = true;
        let correctCount = 0;
        questions.forEach((q, qi)=>{
          const isCorrect = selected[qi] === q.answer;
          if(isCorrect) correctCount++;
          allCorrect = allCorrect && !!isCorrect;
          // 禁用此题所有按钮
          const card = cont.children[qi+1]; // 第0个是timerBox，所以题卡从1开始
          const opts = card.querySelector('.grid');
          Array.from(opts.querySelectorAll('button')).forEach(b=> b.disabled = true);
          // 仅将所选按钮改为绿/红
          if(selectedBtn[qi]){
            selectedBtn[qi].className = 'px-3 py-2 rounded ' + (isCorrect ? 'bg-green-600 hover:bg-green-600' : 'bg-red-600 hover:bg-red-600');
          }
        });
        // 全对：自动完成测验并弹出成就弹窗
        if(allCorrect){
          updateModuleProgress(currentModule.id, {completed:true, unlocked:true, quizCompleted:true});
          const pop=document.getElementById('achievementPopup'); pop.classList.remove('hidden'); pop.classList.add('flex');
          return; // 不再需要手动 Complete
        }
        // 非全对：弹出结果窗口显示正确题数
        const resultPop = document.getElementById('quizResultPopup');
        const resultText = document.getElementById('quizResultText');
        resultText.textContent = `You got ${correctCount}/${questions.length} questions correct. Keep it up!`;
        resultPop.classList.remove('hidden'); resultPop.classList.add('flex');
        const restartBtn2 = document.getElementById('resultRestartBtn');
        const backBtn2 = document.getElementById('resultBackBtn');
        restartBtn2.onclick = ()=>{
          resultPop.classList.add('hidden'); resultPop.classList.remove('flex');
          renderQuiz(m); show('quiz');
        };
        backBtn2.onclick = ()=>{
          resultPop.classList.add('hidden'); resultPop.classList.remove('flex');
          openOutline(currentModule); show('outline');
        };
      };
    }
    document.getElementById('completeQuizBtn').onclick = ()=>{
      if(!currentModule) return; const btn=document.getElementById('completeQuizBtn'); if(btn.classList.contains('disabled')) return;
      if(window.quizTimerId){ clearInterval(window.quizTimerId); window.quizTimerId = null; }
      // 完成测验时也确保停止背景音乐
      if(window.stopQuizMusic){ window.stopQuizMusic(); }
      updateModuleProgress(currentModule.id, {completed:true, unlocked:true, quizCompleted:true});
      // Popup
      const pop=document.getElementById('achievementPopup'); pop.classList.remove('hidden'); pop.classList.add('flex');
    };
    document.getElementById('closePopup').onclick = ()=>{ const pop=document.getElementById('achievementPopup'); pop.classList.add('hidden'); pop.classList.remove('flex'); window.location.href = 'dashboard.html'; };

    // ---- Dashboard ----
    function renderDashboard(){
      const p=getProgress(); const ids=Object.keys(p);
      // Completed list
      const list=document.getElementById('completedList'); list.innerHTML='';
      modules.forEach(m=>{ const li=document.createElement('li'); const prog=p[m.id]||{completed:false, unlocked:false}; li.textContent = (m.title||m.id)+ (prog.completed ? (prog.unlocked ? ' — Unlocked ⭐' : ' — Completed') : ' — Not started'); list.appendChild(li); });
      // Achievements
      const ach=document.getElementById('achievements'); ach.innerHTML='';
      const unlockedCount = modules.filter(m=> (p[m.id]||{}).unlocked).length;
      if(unlockedCount>0){ const li=document.createElement('li'); li.textContent='✨ Space Explorer — '+unlockedCount+' star'+(unlockedCount>1?'s':'')+' unlocked'; ach.appendChild(li); }
      if(unlockedCount===0){ const li=document.createElement('li'); li.textContent='No achievements yet. Complete quizzes to earn badges!'; ach.appendChild(li); }
      // Mini knowledge graph
      const dsvg=document.getElementById('dashGraph'); while(dsvg.firstChild) dsvg.removeChild(dsvg.firstChild);
      const w=dsvg.clientWidth, h=dsvg.clientHeight; const gap=Math.min(160, w/Math.max(2,modules.length||1));
      modules.forEach((m,i)=>{
        const cx=(i+1)*gap; const cy=h/2; const prog=p[m.id]||{unlocked:false};
        const star=document.createElementNS('http://www.w3.org/2000/svg','circle'); star.setAttribute('cx',cx); star.setAttribute('cy',cy); star.setAttribute('r', prog.unlocked? 12:8); star.setAttribute('fill', prog.unlocked? '#ffd700':'#777'); star.style.filter='drop-shadow(0 0 8px rgba(255,215,0,'+(prog.unlocked?'.9':'.2')+'))'; dsvg.appendChild(star);
        const label=document.createElementNS('http://www.w3.org/2000/svg','text'); label.setAttribute('x',cx+18); label.setAttribute('y',cy+4); label.setAttribute('fill','#fff'); label.textContent= (m.id!==undefined && m.id!==null) ? String(m.id) : ''; dsvg.appendChild(label);
      });
    }

    // Initial view
    show('home');

    // Helpers for rendering extracted_entities on the summary page
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
    }
    function renderExtractedEntitiesHTML(ee){
      if(!ee || typeof ee!== 'object') return '<p class="text-white/60 italic">No extracted entities available.</p>';
      const tabDefs = [
        { name:'category', label:'Category', keys:['category'] },
        { name:'benefits', label:'Benefits', keys:['benefits'] },
        { name:'confidence', label:'Confidence', keys:['confidence'] },
        { name:'core_problems', label:'Core Problems', keys:['core_problems','core_problem','problems'] },
        { name:'gaps', label:'Gaps', keys:['gaps'] },
        { name:'key_outcomes', label:'Key Outcomes', keys:['key_outcomes','outcomes'] },
        { name:'key_techniques', label:'Key Techniques', keys:['key_techniques','techniques'] },
        { name:'opportunities', label:'Opportunities', keys:['opportunities'] },
        { name:'solution_types', label:'Solution Types', keys:['solution_types','solutions'] },
      ];
      let headerHtml = '<div id="eeTabs" class="flex flex-wrap gap-2 border-b border-white/10 pb-2">';
      let panelsHtml = '<div id="eeTabPanels" class="mt-3">';
      tabDefs.forEach(def=>{
        let value = null;
        for(const k of def.keys){ if(ee && ee[k]!==undefined){ value = ee[k]; break; } }
        const hasData = value!=null && (Array.isArray(value)? value.length>0 : (typeof value==='object'? Object.keys(value).length>0 : String(value).trim()!==''));
        headerHtml += `<button type="button" data-tab="${def.name}" class="px-3 py-1 rounded ${hasData? 'bg-white/10 hover:bg-white/20 text-white':'bg-white/5 text-white/50 cursor-not-allowed'}">${escapeHtml(def.label)}</button>`;
        let panelContent = '';
        if(!hasData){ panelContent = '<p class="text-white/60 italic">No data in this section.</p>'; }
        else if(Array.isArray(value)){
          panelContent = `<ul class="list-disc ml-5">${value.map(it=>`<li>${escapeHtml(String(it))}</li>`).join('')}</ul>`;
        } else if (value && typeof value === 'object'){
          const subKeys = Object.keys(value);
          panelContent = subKeys.map(sk=>{
            const sv = value[sk];
            const subTitle = sk.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
            if(Array.isArray(sv)){
              return `<div class="mt-1"><div class="text-white/70">${escapeHtml(subTitle)}</div><ul class="list-disc ml-5">${sv.map(x=>`<li>${escapeHtml(String(x))}</li>`).join('')}</ul></div>`;
            } else {
              return `<div class="mt-1"><div class="text-white/70">${escapeHtml(subTitle)}</div><p>${escapeHtml(String(sv))}</p></div>`;
            }
          }).join('');
        } else {
          panelContent = `<p>${escapeHtml(String(value))}</p>`;
        }
        panelsHtml += `<div class="ee-panel ${hasData? '':'opacity-60'}" data-tab="${def.name}" data-empty="${hasData? 'false':'true'}">${panelContent}</div>`;
      });
      headerHtml += '</div>'; panelsHtml += '</div>';
      return headerHtml + panelsHtml;
    }
    function initExtractedEntitiesTabs(container){
      if(!container) return;
      const tabs = container.querySelectorAll('#eeTabs [data-tab]');
      const panels = container.querySelectorAll('#eeTabPanels .ee-panel');
      function setActive(name){
        tabs.forEach(btn=>{
          const isActive = btn.dataset.tab === name;
          btn.classList.toggle('bg-blue-600', isActive);
          btn.classList.toggle('text-white', isActive);
          btn.classList.toggle('bg-white/10', !isActive);
          btn.classList.toggle('text-white/70', !isActive);
        });
        panels.forEach(p=>{ p.classList.toggle('hidden', p.dataset.tab !== name); });
      }
      let defaultTab = null;
      panels.forEach(p=>{ if(defaultTab==null && p.dataset.empty !== 'true'){ defaultTab = p.dataset.tab; } });
      if(defaultTab==null && panels[0]) defaultTab = panels[0].dataset.tab;
      if(defaultTab) setActive(defaultTab);
      tabs.forEach(btn=>{
        if(btn.classList.contains('cursor-not-allowed')) return; // skip disabled tabs
        btn.addEventListener('click', ()=> setActive(btn.dataset.tab));
      });
    }
    document.getElementById('completeQuizBtn').onclick = ()=>{
      if(!currentModule) return; const btn=document.getElementById('completeQuizBtn'); if(btn.classList.contains('disabled')) return;
      if(window.quizTimerId){ clearInterval(window.quizTimerId); window.quizTimerId = null; }
      // 完成测验时也确保停止背景音乐
      if(window.stopQuizMusic){ window.stopQuizMusic(); }
      updateModuleProgress(currentModule.id, {completed:true, unlocked:true, quizCompleted:true});
      // Popup
      const pop=document.getElementById('achievementPopup'); pop.classList.remove('hidden'); pop.classList.add('flex');
    };
    document.getElementById('closePopup').onclick = ()=>{ const pop=document.getElementById('achievementPopup'); pop.classList.add('hidden'); pop.classList.remove('flex'); window.location.href = 'dashboard.html'; };

    // ---- Dashboard ----
    function renderDashboard(){
      const p=getProgress(); const ids=Object.keys(p);
      // Completed list
      const list=document.getElementById('completedList'); list.innerHTML='';
      modules.forEach(m=>{ const li=document.createElement('li'); const prog=p[m.id]||{completed:false, unlocked:false}; li.textContent = (m.title||m.id)+ (prog.completed ? (prog.unlocked ? ' — Unlocked ⭐' : ' — Completed') : ' — Not started'); list.appendChild(li); });
      // Achievements
      const ach=document.getElementById('achievements'); ach.innerHTML='';
      const unlockedCount = modules.filter(m=> (p[m.id]||{}).unlocked).length;
      if(unlockedCount>0){ const li=document.createElement('li'); li.textContent='✨ Space Explorer — '+unlockedCount+' star'+(unlockedCount>1?'s':'')+' unlocked'; ach.appendChild(li); }
      if(unlockedCount===0){ const li=document.createElement('li'); li.textContent='No achievements yet. Complete quizzes to earn badges!'; ach.appendChild(li); }
      // Mini knowledge graph
      const dsvg=document.getElementById('dashGraph'); while(dsvg.firstChild) dsvg.removeChild(dsvg.firstChild);
      const w=dsvg.clientWidth, h=dsvg.clientHeight; const gap=Math.min(160, w/Math.max(2,modules.length||1));
      modules.forEach((m,i)=>{
        const cx=(i+1)*gap; const cy=h/2; const prog=p[m.id]||{unlocked:false};
        const star=document.createElementNS('http://www.w3.org/2000/svg','circle'); star.setAttribute('cx',cx); star.setAttribute('cy',cy); star.setAttribute('r', prog.unlocked? 12:8); star.setAttribute('fill', prog.unlocked? '#ffd700':'#777'); star.style.filter='drop-shadow(0 0 8px rgba(255,215,0,'+(prog.unlocked?'.9':'.2')+'))'; dsvg.appendChild(star);
        const label=document.createElementNS('http://www.w3.org/2000/svg','text'); label.setAttribute('x',cx+18); label.setAttribute('y',cy+4); label.setAttribute('fill','#fff'); label.textContent= (m.id!==undefined && m.id!==null) ? String(m.id) : ''; dsvg.appendChild(label);
      });
    }

    // Initial view
    show('home');

    function renderConnectionsMatrixIntro(m){
      const container = document.getElementById('connectionsMatrixBox');
      if(!container) return;
      container.innerHTML = '';
      if(!m) return;
      const selCats = (m.extracted_entities && Array.isArray(m.extracted_entities.category)) ? m.extracted_entities.category.map(String) : [];
      if(selCats.length === 0){ container.innerHTML = '<p class="text-white/60 italic">无分类数据</p>'; return; }
      // Header
      const header = document.createElement('div');
      header.className = 'text-xs font-semibold tracking-wider mb-1 text-indigo-300';
      header.textContent = '';
      container.appendChild(header);
      const neighbors = (Array.isArray(modules)? modules:[]).filter(nb => nb && nb.id !== m.id && Array.isArray((nb.extracted_entities||{}).category) && nb.extracted_entities.category.map(String).some(c => selCats.includes(String(c))));
      const tableWrap = document.createElement('div'); tableWrap.className='overflow-x-auto';
      // 允许横向和纵向滚动，并限制最大高度，表头与首列粘性固定
      tableWrap.style.overflow = 'auto';
      tableWrap.style.maxHeight = '280px';
      tableWrap.style.position = 'relative';
      const tbl = document.createElement('table'); tbl.className='text-sm';
      tbl.style.borderCollapse = 'separate';
      tbl.style.borderSpacing = '0';
      const thead = document.createElement('thead'); const htr = document.createElement('tr');
      const th0 = document.createElement('th'); th0.className='px-2 py-1 text-left text-white/80'; th0.textContent='Modules'; htr.appendChild(th0);
      // 表头粘性（包含左上角单元格）
      th0.style.position = 'sticky';
      th0.style.top = '0';
      th0.style.left = '0';
      th0.style.zIndex = '3';
      th0.style.background = 'rgba(15,23,42,0.9)';
      th0.style.backdropFilter = 'blur(2px)';
      th0.style.minWidth = '160px';
      selCats.forEach(cat => { const th = document.createElement('th'); th.className='px-2 py-1 text-white/80'; th.textContent = cat; 
        th.style.position = 'sticky';
        th.style.top = '0';
        th.style.zIndex = '2';
        th.style.background = 'rgba(15,23,42,0.9)';
        th.style.backdropFilter = 'blur(2px)';
        th.style.minWidth = '140px';
        htr.appendChild(th); });
      thead.appendChild(htr); tbl.appendChild(thead);
      const tbody = document.createElement('tbody');
      neighbors.forEach(nb => {
        const tr = document.createElement('tr');
        const td0 = document.createElement('td'); td0.className='px-2 py-1 text-white/90';
        const link = document.createElement('a');
        link.href = 'index.html?moduleId=' + encodeURIComponent(String(nb.id)) + '&start=intro';
        link.textContent = String(nb.title||nb.id);
        link.className = 'hover:underline hover:text-indigo-300';
        td0.appendChild(link); tr.appendChild(td0);
        // 首列粘性
        td0.style.position = 'sticky';
        td0.style.left = '0';
        td0.style.zIndex = '1';
        td0.style.background = 'rgba(15,23,42,0.85)';
        td0.style.minWidth = '160px';
        const nbCats = (nb.extracted_entities && Array.isArray(nb.extracted_entities.category)) ? nb.extracted_entities.category.map(String) : [];
        selCats.forEach(cat => {
          const td = document.createElement('td'); td.className='px-2 py-1';
          const has = nbCats.includes(cat);
          const dot = document.createElement('span'); dot.className='inline-block w-3 h-3 rounded-full border border-white/20';
          dot.style.backgroundColor = has ? (categoryColorMap[cat] || '#6e7ff5') : 'transparent';
          td.appendChild(dot); tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      tbl.appendChild(tbody); tableWrap.appendChild(tbl);
      container.appendChild(tableWrap);
    }

    // Initial view
    show('home');

  </script>
</body>
</html>